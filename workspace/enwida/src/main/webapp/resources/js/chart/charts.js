(function(){define("scale",[],function(){return{init:function(e){var t,n;return this.chart=e,this.options=this.chart.options.scale,this.setupXScale(),this.setupYScale(),this.setupDomain(this.chart.xScale,"x"),this.setupDomain(this.chart.yScale,"y"),typeof (t=this.chart.xScale).nice=="function"&&t.nice(),typeof (n=this.chart.yScale).nice=="function"?n.nice():void 0},setupXScale:function(){if(!(this.options&&this.options.x&&this.options.x.type)){this.setupXScaleLinear();return}switch(this.options.x.type){case"linear":return this.setupXScaleLinear();case"ordinal":return this.setupXScaleOrdinal();case"date":return this.setupXScaleDate()}},setupYScale:function(){return this.setupYScaleLinear()},setupXScaleLinear:function(){return this.chart.xScale=d3.scale.linear().range([0,this.chart.options.width])},setupXScaleOrdinal:function(){var e,t,n,r;return(n=(t=this.options["x"])["domain"])==null&&(t.domain={type:"map"}),e=(r=this.options.x.padding)!=null?r:.1,this.chart.xScale=d3.scale.ordinal().rangeRoundBands([0,this.chart.options.width],e)},setupXScaleDate:function(){var e=this;return this.chart.xScale=d3.time.scale().range([0,this.chart.options.width]),this.chart.xScale.tickFormat=function(t){var n,r,i,s,o;return n=(i=(s=e.options)!=null?(o=s.x)!=null?o.dateFormats:void 0:void 0)!=null?i:[["%Y","%Y-%m-%d"],["%m","%b"],["%d","%d"],["%H:%M","%H:%M"]],r=null,function(e){var t,i,s,o,u;s=function(t){return r=e,d3.time.format(t[1])(e)};if(r==null)return s(n[0]);for(o=0,u=n.length;o<u;o++){i=n[o],t=d3.time.format(i[0]);if(t(e)!==t(r))return s(i)}return s(n[n.length-1])}}},setupYScaleLinear:function(){return this.chart.yScale=d3.scale.linear().range([this.chart.options.height,0])},setupDomain:function(e,t){var n,r,i,s,o;if(this.options==null||this.options[t]==null||this.options[t]["domain"]==null||!this.options[t].domain){this.setupDomainExtent(e,t);return}r=this.options[t].domain.type;if(r instanceof Array){o=[];for(i=0,s=r.length;i<s;i++)n=r[i],o.push(this.applyStrategy(n,e,t));return o}return this.applyStrategy(r,e,t)},applyStrategy:function(e,t,n){switch(e){case"extent":return this.setupDomainExtent(t,n);case"map":return this.setupDomainMap(t,n);case"stretch":return this.setupDomainStretch(t);case"fixed":return this.setupDomainFixed(t,n);default:throw new Error("Not a valid scale type: "+e)}},setupDomainExtent:function(e,t){return e.domain(d3.extent(this.allValues(t)))},setupDomainStretch:function(e,t,n){var r;return t==null&&(t=.9),n==null&&(n=1.1),r=e.domain(),e.domain([r[0]*t,r[1]*n])},setupDomainMap:function(e,t){return e.domain(this.allValues(t))},setupDomainFixed:function(e,t){var n,r;return r=this.getBound(this.options[t].domain.low,t),n=this.getBound(this.options[t].domain.high,t),e.domain([r,n])},allValues:function(e){var t,n,r,i,s,o,u,a,f;t=[],i={},f=this.chart.data;for(s=0,u=f.length;s<u;s++){r=f[s];for(o=0,a=r.length;o<a;o++)n=r[o],i[n[e]]==null&&(t.push(n[e]),i[n[e]]=!0)}return t},getBound:function(e,t){if($.isNumeric(e))return e;switch(e){case"min":return d3.min(this.chart.data,function(e){return e[t]});case"max":return d3.max(this.chart.data,function(e){return e[t]});default:throw new Error("Not a valid bound: "+e)}}}})}).call(this),function(){define("generic_chart",["scale"],function(e){var t;return t=function(){function t(t){var n,r,i;if(t==null||t.lines==null)throw"No data given";n={margin:{top:20,left:50,right:20,bottom:30},width:960,height:500,parent:"body"},this.options=$.extend(n,t),this.lines=t.lines,this.xLabel=(r=this.options.xLabel)!=null?r:"",this.yLabel=(i=this.options.yLabel)!=null?i:"",this.lineLabels=this.lines.map(function(e){return e.title}),this.data=this.lines.map(function(e){return e.dataPoints}),e.init(this),this.generateAxes()}return t.prototype.generateXAxis=function(){return this.xAxis=d3.svg.axis().scale(this.xScale).orient("bottom")},t.prototype.generateYAxis=function(){return this.yAxis=d3.svg.axis().scale(this.yScale).orient("left")},t.prototype.generateAxes=function(e,t){return this.generateXAxis(),this.generateYAxis()},t.prototype.drawSvg=function(){var e,t;if(this.svg!=null)return;return t=this.options.width+this.options.margin.left+this.options.margin.right,e=this.options.height+this.options.margin.top+this.options.margin.bottom,this.svg=d3.select(this.options.parent).append("svg").attr("width",t).attr("height",e).append("g").attr("transform","translate("+this.options.margin.left+","+this.options.margin.top+")")},t.prototype.drawXAxis=function(e){return this.svg.append("g").attr("class","x axis").attr("transform","translate(0,"+this.options.height+")").call(e).append("text").attr("x",this.options.width).attr("y",-5).attr("text-anchor","end").text(""+this.xLabel)},t.prototype.drawYAxis=function(e){return this.svg.append("g").attr("class","y axis").call(e).append("text").attr("transform","rotate(-90)").attr("y",12).attr("text-anchor","end").text(""+this.yLabel)},t.prototype.drawLegend=function(){return this.legend=this.svg.append("g").attr("class","legend").attr("transform","translate(50,30)").attr("data-style-padding",10).call(d3.legend)},t.prototype.drawAxes=function(){return this.drawXAxis(this.xAxis),this.drawYAxis(this.yAxis)},t}(),{init:function(e){return new t(e)}}})}.call(this),function(){define("line_chart",["generic_chart"],function(e){var t;return t=function(){function t(t){this.chart=e.init(t)}return t.prototype.generateLine=function(){var e=this;return d3.svg.line().x(function(t){return e.chart.xScale(t.x)}).y(function(t){return e.chart.yScale(t.y)})},t.prototype.drawLine=function(e,t){var n;return t==null&&(t=0),n=this.generateLine(),this.chart.svg.append("path").datum(e).attr("class","line line"+t).attr("data-legend",this.chart.lineLabels[t]).attr("d",n)},t.prototype.drawDots=function(e,t){var n=this;return t==null&&(t=0),this.chart.svg.selectAll("dot").data(e).enter().append("circle").attr("class","dot dot"+t).attr("r",4.5).attr("cx",function(e){return n.chart.xScale(e.x)}).attr("cy",function(e){return n.chart.yScale(e.y)}).attr("original-title",function(e){var r,i,s,o;return r=e.x,((i=n.chart.options)!=null?(s=i.scale)!=null?(o=s.x)!=null?o.type:void 0:void 0:void 0)==="date"&&(r=d3.time.format("%Y-%m-%d %H:%M")(new Date(r))),$("<div>").append($("<h6>").text(n.chart.lines[t].title)).append($("<table cellpadding='2'>").append($("<tr>").append($("<td align='left'>").text(n.chart.xLabel)).append($("<td align='left'>").append($("<b>").text(r)))).append($("<tr>").append($("<td align='left'>").text(n.chart.yLabel)).append($("<td align='left'>").append($("<b>").text(e.y))))).html()})},t.prototype.draw=function(){var e,t,n,r,i;this.chart.drawSvg(),this.chart.drawAxes(),i=this.chart.data;for(e=n=0,r=i.length;n<r;e=++n)t=i[e],this.drawLine(t,e),this.drawDots(t,e);return this.chart.drawLegend()},t.prototype.redraw=function(){return this.chart.svg=null,this.draw()},t}(),{init:function(e){return new t(e)}}})}.call(this),function(){define("bar_chart",["generic_chart"],function(e){var t;return t=function(){function t(t){this.chart=e.init(t)}return t.prototype.drawBars=function(e){var t,n,r,i,s=this;return i=this.chart.options.scale,r=i&&i.x&&i.x.type==="ordinal",r?(n=this.chart.xScale.rangeBand(),t=0):(n=this.chart.xScale(this.minInterval("x"))-this.chart.xScale(0),n*=.9,t=n/2),this.chart.svg.selectAll(".bar").data(e).enter().append("rect").attr("class","bar").attr("x",function(e){return s.chart.xScale(e.x)-t}).attr("y",function(e){return s.chart.yScale(e.y)}).attr("width",n).attr("height",function(e){return s.chart.options.height-s.chart.yScale(e.y)}).attr("fill",function(e){return"#0000aa"})},t.prototype.minInterval=function(e){var t,n,r,i,s;s=null,i=this.chart.data[0][e],r=1;while(r<this.chart.data.length){t=this.chart.data[r][e],n=t-i;if(!s||s>n)s=n;i=t,r+=1}return s},t.prototype.draw=function(){return this.chart.drawSvg(),this.chart.drawAxes(),this.drawBars(this.chart.data[0])},t.prototype.redraw=function(){return this.chart.svg=null,this.draw()},t}(),{init:function(e){return new t(e)}}})}.call(this),function(){define("carpet_chart",["generic_chart"],function(e){var t;return t=function(){function t(t){this.chart=e.init(t)}return t.prototype.drawCarpet=function(e){var t,n,r,i,s,o=this;return i=this.chart.xScale.domain(),s=this.chart.yScale.domain(),r=this.chart.options.width/i.length,n=this.chart.options.height/s.length,t=d3.scale.linear().range(["#00f","#f00"]).domain(d3.extent(e.map(function(e){return e.v}))),this.chart.svg.selectAll(".carpet").data(e).enter().append("rect").attr("class","carpet").attr("x",function(e){return o.chart.xScale(e.x)}).attr("y",function(e){return o.chart.yScale(e.y)-n}).attr("fill",function(e){return t(e.v)}).attr("width",r).attr("height",n)},t.prototype.draw=function(){return this.chart.drawSvg(),this.chart.drawAxes(),this.drawCarpet(this.chart.data[0])},t.prototype.redraw=function(){return this.chart.svg=null,this.draw()},t}(),{init:function(e){return new t(e)}}})}.call(this),function(){define("navigation",[],function(){var e;return e=function(){function e(e){this.element=e,this.chartId=$(this.element).attr("data-chart-id");if(!this.chartId)throw"No chart ID given"}return e.prototype.productParts=["type","posneg","timeslot"],e.prototype.treeParts=["type","timeslot","posneg"],e.prototype.dateFormat=d3.time.format("%Y-%m-%d"),e.prototype.datePickerFormat="yyyy-mm-dd",e.prototype.draw=function(e,t){var n=this;return e==null&&(e=this.element),this.getNavigationData(function(r,i){var s;return r!=null?t(r):(e.append(n.getNavigationElements(i)),s=n.navigationData.defaults,n.setProduct(s.tsoId,s.product),n.element.find(".resolutions").val(s.resolution),n.setTimeRange(s.timeRange),typeof t=="function"?t(null,i):void 0)})},e.prototype.getNavigationData=function(e){var t=this;return $.ajax("navigation.test",{data:{chartId:this.chartId},success:function(n){return t.navigationData=n,e(null,n)},error:function(t){return e(t)}})},e.prototype.getNavigationElements=function(e){var t,n,r;return console.log(e),n=$("<div class='navigation'>"),t=$("<div class='productselect'>"),r=$("<div class='timeselect'>"),r.append(this.getTimeElement(e.timeRangeMax,"from")),r.append(this.getTimeElement(e.timeRangeMax,"to")),t.append(this.getTsoElement(e.tsos)),t.append(this.getProductElements(e.productTrees[0])),r.append(this.getResolutionElement(e.allResolutions)),n.append(t),n.append(r),n},e.prototype.getTimeElement=function(e,t){var n,r=this;return t==null&&(t="time"),n=$("<input type='text' class='"+t+"'>"),n.datepicker({format:this.datePickerFormat}),n.on("changeDate",function(e){return r.timeRange[t]=e.date}),n},e.prototype.getTsoElement=function(e){var t,n,r,i=this;r=$("<select class='tsos'>");for(t in e)n=$("<option value='"+t+"'>"),n.text(e[t]),r.append(n);return r.change(function(){return i.updateSelections()}),r},e.prototype.getProductElements=function(e){var t,n,r,i,s,o,u,a=this;r=$("<div class='product'>"),r.css("display","inline"),t=this.getTreeDepth(e.root),u=this.productParts;for(s=0,o=u.length;s<o;s++)n=u[s],i=$("<select class='product-"+n+"'>"),i.change(function(){return a.updateSelections()}),r.append(i);return r},e.prototype.getResolutionElement=function(e){var t,n,r,i,s;r=$("<select class='resolutions'>");for(i=0,s=e.length;i<s;i++)n=e[i],t=$("<option value='"+n+"'>"),t.text(n),r.append(t);return r.select(this.navigationData.defaults.resolution),r},e.prototype.getTreeDepth=function(e){var t,n;n=0,t=e;while(t.children.length>0)n+=1,t=t.children[0];return n},e.prototype.setProduct=function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w;h=this.element.find(".tsos"),h.val(e),f=_.find(this.navigationData.productTrees,function(t){return t.tso===e}),t=""+t,u=f.root,c={};for(r=p=0,g=t.length;0<=g?p<g:p>g;r=0<=g?++p:--p)i=parseInt(t.substring(r,r+1)),s=this.productParts[r],c[s]=i;o=null,w=[];for(r=d=0,y=t.length;0<=y?d<y:d>y;r=0<=y?++d:--d){o=null,s=this.treeParts[r],l=this.element.find(".product-"+s),l.empty(),b=u.children;for(v=0,m=b.length;v<m;v++)n=b[v],a=$("<option value='"+n.id+"'>"),a.text(n.name),n.id===c[s]&&(a.attr("selected",!0),o=n),l.append(a);w.push(u=o!=null?o:u.children[0])}return w},e.prototype.setTimeRange=function(e){return this.timeRange=e,this.element.find(".from").datepicker("setValue",new Date(e.from)),this.element.find(".to").datepicker("setValue",new Date(e.to))},e.prototype.getProduct=function(){var e,t,n,r,i;t="",i=this.productParts;for(n=0,r=i.length;n<r;n++)e=i[n],t+=$(this.element).find(".product-"+e).val();return console.log(t),t},e.prototype.getTso=function(){return this.element.find(".tsos").val()},e.prototype.getResolution=function(){return this.element.find(".resolutions").val()},e.prototype.getTimeRange=function(){return console.log(this.timeRange),this.timeRange},e.prototype.updateSelections=function(){return this.setProduct(parseInt(this.getTso()),this.getProduct())},e.prototype.isDateScale=function(){return this.navigationData.isDateScale},e}()})}.call(this),function(){define("spreadsheet",[],function(){var e;return e=function(){function e(e,t){this.isDateScale=t!=null?t:!1,this.element=$(e)}return e.prototype.draw=function(e){var t;return this.element.empty(),t=$("<table>"),t.append(this.getTableHeader(e)),this.element.append(t),this.addTableRows(t,e)},e.prototype.getTableHeader=function(e,t){var n,r,i,s,o;t==null&&(t="Time"),r=$("<tr>"),r.append($("<th>").text(t)),o=[];for(i=0,s=e.length;i<s;i++)n=e[i],console.log(n),o.push(r.append($("<th>").text(n.title)));return o},e.prototype.addTableRows=function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x;console.log("datescale: "+this.isDateScale),i=d3.time.format("%Y-%m-%d %H:%M"),a={};for(l=0,d=t.length;l<d;l++){o=t[l],b=o.dataPoints;for(c=0,v=b.length;c<v;c++)s=b[c],(w=a[y=s.x])==null&&(a[y]={}),a[s.x][o.title]=s.y}E=_(a).keys().sort(),x=[];for(h=0,m=E.length;h<m;h++){f=E[h],u=$("<tr>"),n=$("<td>"),n.text(this.isDateScale?i(new Date(parseInt(f))):f),u.append(n);for(p=0,g=t.length;p<g;p++)o=t[p],r=$("<td>"),r.text((S=a[f][o.title])!=null?S:""),u.append(r);x.push(e.append(u))}return x},e}()})}.call(this),function(){define("chart_manager",["line_chart","bar_chart","carpet_chart","navigation","spreadsheet"],function(e,t,n,r,i){var s;return s=function(){function t(e){this.element=e,this.chartId=$(this.element).attr("data-chart-id"),this.type=$(this.element).attr("data-chart-type");if(!this.chartId)throw"No ID given!"}return t.prototype.chartOptions={},t.prototype.draw=function(){var e,t,n=this;return $(this.element).empty(),e=$("<div class='chartmeta'>"),t=$("<div class='spreadsheet'>"),this.element.append($("<div class='visual'>")),this.element.append(e),this.element.append(t),this.spreadsheet=new i(t),this.navigation=new r(this.element),this.navigation.draw(e,function(e,t){var r,i;if(e!=null)throw e;return r=$("<h2>"),r.text(t.title),n.element.prepend(r),n.element.find(".navigation select").change(function(){return n.drawLines()}),n.element.find(".from").on("changeDate",function(){return n.drawLines()}),n.element.find(".to").on("changeDate",function(){return n.drawLines()}),n.spreadsheet.isDateScale=t.isDateScale,i=$("<input type='button' value='Show data'>"),i.click(function(){return n.element.find(".spreadsheet").toggle()}),n.element.append(i),n.chartOptions.xLabel=t.xAxisLabel,n.chartOptions.yLabel=t.yAxisLabel,n.drawDefaultChart(t)})},t.prototype.drawDefaultChart=function(e){var t,n=this;return t=e.defaults,this.getLines(t.product,t.tsoId,t.timeRange.from,t.timeRange.to,t.resolution,function(e,t){return e!=null?console.log(e):(console.log(t),n.drawData(t))})},t.prototype.getLines=function(e,t,n,r,i,s){var o;return o=d3.time.format("%Y-%m-%d"),$.ajax("lines.test",{data:{chartId:this.chartId,product:e,tso:t,startTime:o(new Date(n)),endTime:o(new Date(r)),resolution:i},success:function(e){return s(null,e)},error:function(e){return s(e)}})},t.prototype.drawLines=function(e){var t,n=this;return t=this.navigation.getTimeRange(),this.getLines(this.navigation.getProduct(),this.navigation.getTso(),t.from,t.to,this.navigation.getResolution(),function(t,r){if(t!=null)throw t;return n.drawData(r),typeof e=="function"?e():void 0})},t.prototype.drawData=function(e){var t;return console.log(e),$(this.element).find("svg").remove(),t=this.getChart(e,this.type),t.draw(),$("circle").tipsy({gravity:"sw",html:!0,opacity:.95}),this.spreadsheet.draw(e)},t.prototype.getChart=function(t,r){r==null&&(r="line"),this.chartOptions.parent=".chart[data-chart-id='"+this.chartId+"'] .visual",this.chartOptions.lines=t;switch(r){case"line":return this.chartOptions.scale={x:{type:this.navigation.isDateScale()?"date":"linear"}},e.init(this.chartOptions);case"carpet":return this.chartOptions.scale={x:{type:"ordinal",padding:0}},this.chartOptions.lines=this.toCarpet(t),n.init(this.chartOptions)}},t.prototype.toCarpet=function(e){return e[0].dataPoints.map(function(e){var t,n,r;return t=new Date(e.x),t=t.getMonth()+"/"+t.getDate(),n=new Date(e.x),n=n.getHours(),r=e.y,e.x=t,e.y=n,e.v=r,e}),e},t}()})}.call(this),function(){require.config({baseUrl:"/enwida/resources/js/chart/lib"}),require(["line_chart","bar_chart","carpet_chart","chart_manager"],function(e,t,n,r){return $(document).ready(function(){return $(".chart").each(function(){var e;return e=new r($(this)),e.draw()})})})}.call(this),define("../charts",function(){});